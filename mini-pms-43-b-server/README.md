# 43-a. 애플리케이션 서버 아키텍처로 전환하기 : 세션 다루기

이번 훈련에서는,
-




## 훈련 목표
-

## 훈련 내용
-

## 실습


### 1단계 - 각 클라이언트 마다 별도의 세션으로 다뤄야 하는 이유를 이해한다.

다음 순서에 따라 테스트 한다.

- 한 개의 클라이언트로 접속한다.
  - `aaa@test.com` 사용자로 로그인한다.
- 또 한 개의 클라이언트로 접속한다.
  - `명령> /whoami` 명령을 사용해 로그인 사용자 정보를 출력한다.
  - 이 클라이언트는 로그인 하지 않았는데 사용자 정보를 출력한다.
- 이유?
  - 로그인 정보를 모든 클라이언트가 공유하는 context 맵에 보관하기 때문이다.
- 해결책?
  - 클라이언트 전용 보관소를 사용하여 각 클라이언트 전용 정보를 다룬다.

### 2단계 - 클라이언트와 서버 간의 프로토콜 변경한다.

- 클라이언트가 보내는 요청 형식

```
클라이언트 세션 아이디 CRLF
요청 명령 CRLF

예)
SessionID=1299
/board/list
```

- 서버가 보내는 응답 형식

```
클라이언트 세션 아이디 CRLF
응답 데이터 CRLF
...
CRLF

예)
SessionID=1277
[게시물 목록]
...
...

```


### 3단계 - 클라이언트 요청을 받을 때 세션 아이디를 분석한다.

- com.eomcs.pms.ServerApp 클래스 변경
  - 클라이언트 요청을 분석하여 세션을 생성한다.
  - `prepareSession()` 메서드 추가
- com.eomcs.pms.handler.Request 클래스 변경
  - 세션 아이디를 보관한다.

### 4단계 - 커맨드 객체가 사용할 값을 Request에 모두 담아서 파라미터로 받는다.

- com.eomcs.pms.handler.Command 인터페이스 변경
  - `execute(Request)` 메서드의 파라미터를 변경한다.
- com.eomcs.pms.handler.XxxCommand 클래스 변경
  - 인터페이스 변경에 맞춰 코드를 수정한다.
- com.eomcs.pms.handler.Request 클래스 변경
  - 세션을 제거하는 메서드를 추가한다.
- com.eomcs.pms.ServerApp 클래스 변경
  - `prepareSession()` 메서드 변경
    - 세션 아이디가 무효할 때 새 세션을 만든다.
  - 응답할 때 항상 클라이언트의 세션 ID를 리턴해 줘야 한다.
    - 필터 체인을 실행하기 전에 세션 ID를 먼저 응답한다.


## 실습 결과

- src/main/java/com/eomcs/pms/ServerApp.java 변경
